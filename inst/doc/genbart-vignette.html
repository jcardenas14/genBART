<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Jacob Cardenas" />

<meta name="date" content="2017-05-18" />

<title>genBART package Vignette</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>



<link href="data:text/css;charset=utf-8,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23header%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0A%7D%0Apre%20%7B%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%20code%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" rel="stylesheet" type="text/css" />

</head>

<body>




<h1 class="title toc-ignore">genBART package Vignette</h1>
<h4 class="author"><em>Jacob Cardenas</em></h4>
<h4 class="date"><em>2017-05-18</em></h4>



<p>BART is a user friendly, point and click, R shiny application that was developed as a biostatistical reporting tool for a broad range of high throughput experiments such as RNA sequencing, Microarray, Flow Cytometry, and Metabolomics. BART provides users with the ability to interactively view and download (all tables and figures generated by the app) the entire analysis workflow:</p>
<ul>
<li>Design file and summary statistics</li>
<li>Quality control metrics</li>
<li>Unsupervised analysis (heatmaps and clustering)</li>
<li>Differential gene expression (easily sortable genelists, venn diagrams)</li>
<li>Gene set analysis</li>
<li>Correlation analysis</li>
</ul>
<p>To make the tools that BART offers more readily available, we introduce the genBART package, a series of functions that transforms R objects generated from modeling packages limma, DESeq2, and edgeR into files that can be uploaded into BART. In the following sections, we illustrate how to use the functions available in genBART by walking through the analysis of a longitudinal microarray study tracking gene expression changes in cynomolgus macaques infected with <em>M. tuberculosis</em> <a href="http://www.jimmunol.org/content/197/12/4817.long">(Skinner et al.)</a>. In addition to microarray data, the study also has flow data that will be incorporated in to demonstrate the flexibility of the BART app.</p>
<h2 style="text-align: center">
Summary of genBART package
</h2>
<table>
<caption>Functions in the genBART package ordered to demonstrate a typical analysis workflow.</caption>
<thead>
<tr class="header">
<th align="left">Function</th>
<th align="left">Purpose</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><code>desInfo()</code></td>
<td align="left">Match design and expression. Define elements of design.</td>
</tr>
<tr class="even">
<td align="left"><code>genDendrograms()</code></td>
<td align="left">normalize and cluster expression.</td>
</tr>
<tr class="odd">
<td align="left"><code>genModules()</code></td>
<td align="left">Generate module (gene set) maps for plotting.</td>
</tr>
<tr class="even">
<td align="left"><code>genModelResults()</code></td>
<td align="left">Process and format modeling results.</td>
</tr>
<tr class="odd">
<td align="left"><code>qBart()|rBart()</code></td>
<td align="left">Run gene set analysis using QuSAGE or ROAST algorthims.</td>
</tr>
<tr class="even">
<td align="left"><code>crossCorr()</code></td>
<td align="left">Run pairwise correlations between two data sets.</td>
</tr>
<tr class="odd">
<td align="left"><code>genFile()</code></td>
<td align="left">Generate and save BART ready .rda file.</td>
</tr>
<tr class="even">
<td align="left"><code>updateFile()</code></td>
<td align="left">Update/add to existing BART file.</td>
</tr>
<tr class="odd">
<td align="left"><code>runBart()</code></td>
<td align="left">Run BART shiny app.</td>
</tr>
</tbody>
</table>
<p>The genBART package contains 10 functions, each of which is listed in the table above. Greater detail on each of these functions and their parameters is available via the help commands in R. Below is a summary of how they are used and integrated into a typical workflow:</p>
<ol style="list-style-type: decimal">
<li><code>desInfo</code> - Check that the samples in expression match the samples in design. Define elements of experimental design/sample information. This initial step is important as the information provided here is used to determine the various ways the data is normalized, annotate the heat maps produced in BART, and generate module maps for plotting.</li>
<li><code>genDendrograms</code> - Use the output from <code>desInfo</code> to perform various normalizations (e.g. to healthy controls, baseline samples, etc.) and hiearchical clustering of the genes.</li>
<li><code>genModules</code> - Use the output from <code>desInfo</code> to generate module maps that show, for each sample, the percentage of probes within a module that are above or below a certain threshold (e.g. mean of healthy controls +- 2 sd).</li>
<li><code>genModuleResults</code> - Use result objects produced by limma, DESeq2, or edgeR to process and format for BART.</li>
<li><code>qBart|rBart</code> - Given a list of gene sets, run either QuSAGE (by also including <code>genModuleResults</code> output as input in <code>qBart</code>) or ROAST, a rotation based approach to gene set testing proposed by Wu et al (2010).</li>
<li><code>crossCorr</code> - Calculate pairwise correlations and p-values between the variables in two data frames or matrices, with the option to correlate by a grouping factor (e.g. time in a longitudinal setting). Flexible to correlate data from different platforms (e.g. microarray vs flow).</li>
<li><code>genFile</code> - Generate and save a BART ready .rda file based on the output objects from the functions above. It is not necessary to run all of the functions in order to generate a BART file, making genBART flexible to the project at hand and the stage of analysis a user is at.</li>
<li><code>updateFile</code> - Allows the user to easily update and/or add on to an exisiting BART file without having to re-run all of the functions.</li>
<li><code>runBart</code> - Run the BART shiny app.</li>
</ol>
<div id="design-information" class="section level3">
<h3>Design Information</h3>
<p>Before running any analysis, the first step in generating a BART ready file is to define the elements of the design file and sample information. Keep in mind that not every one of these elements is necessary for the rest of the genBART functions to run, so in practice, much of this section is left to user discretion and the particular project at hand.</p>
<pre><code>library(genBART)
library(limma)</code></pre>
<p>Below are the first six lines of the design file from the TB microarray study described in the introduction.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(tb.design)
<span class="co">#&gt;                  columnname monkey_id timepoint sample_id clinical_status</span>
<span class="co">#&gt; 1  AVG_Signal__7196763044_K        M1         0   M1-Pre1          Active</span>
<span class="co">#&gt; 5  AVG_Signal__6303256034_B        M1        20    M1-D20          Active</span>
<span class="co">#&gt; 7  AVG_Signal__6303256020_I        M1        42    M1-D42          Active</span>
<span class="co">#&gt; 22 AVG_Signal__7196763078_I       M11         0  M11-Pre1          Latent</span>
<span class="co">#&gt; 26 AVG_Signal__7196771011_D       M11        20   M11-D20          Latent</span>
<span class="co">#&gt; 28 AVG_Signal__7196763087_B       M11        42   M11-D42          Latent</span>
<span class="co">#&gt;    timerange</span>
<span class="co">#&gt; 1        Pre</span>
<span class="co">#&gt; 5      Early</span>
<span class="co">#&gt; 7     Middle</span>
<span class="co">#&gt; 22       Pre</span>
<span class="co">#&gt; 26     Early</span>
<span class="co">#&gt; 28    Middle</span></code></pre></div>
<p>For this study, the function call would be:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">des.info &lt;-<span class="st"> </span><span class="kw">desInfo</span>(<span class="dt">y =</span> tb.expr, <span class="dt">design =</span> tb.design, <span class="dt">data_type =</span> <span class="st">&quot;micro&quot;</span>, 
                    <span class="dt">columnname =</span> <span class="st">&quot;columnname&quot;</span>, <span class="dt">long =</span> <span class="ot">TRUE</span>, <span class="dt">patient_id =</span> <span class="st">&quot;monkey_id&quot;</span>, 
                    <span class="dt">baseline_var =</span> <span class="st">&quot;timepoint&quot;</span>, <span class="dt">baseline_val =</span> <span class="dv">0</span>, 
                    <span class="dt">control_var =</span> <span class="st">&quot;clinical_status&quot;</span>, <span class="dt">control_val =</span> <span class="st">&quot;Latent&quot;</span>, 
                    <span class="dt">time_var =</span> <span class="st">&quot;timepoint&quot;</span>, <span class="dt">summary_var =</span> <span class="ot">NULL</span>, 
                    <span class="dt">responder_var =</span> <span class="st">&quot;clinical_status&quot;</span>, <span class="dt">sample_id =</span> <span class="st">&quot;sample_id&quot;</span>, 
                    <span class="dt">project_name =</span> <span class="st">&quot;TB&quot;</span>)</code></pre></div>
<p>We proceed similarly for the flow data:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">des.info.flow &lt;-<span class="st"> </span><span class="kw">desInfo</span>(<span class="dt">y =</span> tb.flow, <span class="dt">design =</span> tb.flow.des, <span class="dt">data_type =</span> <span class="st">&quot;flow&quot;</span>, 
                         <span class="dt">columnname =</span> <span class="st">&quot;columnname&quot;</span>, <span class="dt">long =</span> <span class="ot">TRUE</span>, <span class="dt">patient_id =</span> <span class="st">&quot;monkey_id&quot;</span>, 
                         <span class="dt">baseline_var =</span> <span class="st">&quot;timepoint&quot;</span>, <span class="dt">baseline_val =</span> <span class="dv">0</span>, 
                         <span class="dt">control_var =</span> <span class="st">&quot;clinical_status&quot;</span>, <span class="dt">control_val =</span> <span class="st">&quot;Latent&quot;</span>, 
                         <span class="dt">time_var =</span> <span class="st">&quot;timepoint&quot;</span>, <span class="dt">summary_var =</span> <span class="ot">NULL</span>, 
                         <span class="dt">responder_var =</span> <span class="st">&quot;clinical_status&quot;</span>, <span class="dt">sample_id =</span> <span class="st">&quot;sample_id&quot;</span>, 
                         <span class="dt">project_name =</span> <span class="st">&quot;TB&quot;</span>)</code></pre></div>
<p>Please refer to the R help for <code>desInfo</code> for more details on function parameters.</p>
</div>
<div id="clustering-generate-dendrograms" class="section level3">
<h3>Clustering (Generate Dendrograms)</h3>
<p>Next we generating dendrograms through hierarchical clustering. This step is necessary to produce the heat maps that can be viewed and downloaded in BART. This can be done through the <code>genDendrograms</code> function, which takes as input the output from <code>desInfo</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dendros &lt;-<span class="st"> </span><span class="kw">genDendrograms</span>(<span class="dt">design_info =</span> des.info)
<span class="co">#&gt; [1] &quot;Normalizing Expression and Clustering....&quot;</span>
<span class="co">#&gt; [1] &quot;Clustering Baseline Median Normalized Heatmap&quot;</span>
<span class="co">#&gt; [1] &quot;Clustering Baseline Healthy Normalized Heatmap&quot;</span>
<span class="co">#&gt; [1] &quot;Clustering All Samples Median Normalized Heatmap&quot;</span>
<span class="co">#&gt; [1] &quot;Clustering All Samples Healthy Normalized Heatmap&quot;</span>
<span class="co">#&gt; [1] &quot;Clustering All Samples Baseline Normalized Heatmap&quot;</span></code></pre></div>
<p>From the output we can see that the data was normalized in three different ways, and this is determined by the study design and the information given to <code>desInfo</code>. For example, if the study included healthy controls then additional normalizations to healthies would have been included.</p>
</div>
<div id="generate-module-maps" class="section level3">
<h3>Generate Module Maps</h3>
<p>By default, BART automatically generates module maps using a set of 260 biologically similar and generally co-regulated Baylor modules. The user is also able to provide his own list of gene sets to plot. As an example, we formed gene sets by choosing 10 clusters determined through hierarchical clustering. The function call to generate the gene set maps is below.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mods &lt;-<span class="st"> </span><span class="kw">genModules</span>(<span class="dt">design_info =</span> des.info, <span class="dt">gene_sets =</span> clusters)</code></pre></div>
</div>
<div id="sample-limma-analysis" class="section level3">
<h3>Sample limma Analysis</h3>
<p>Now we demonstrate a quick walkthrough of limma analysis for microarray and flow data. The example we are using comes from a study in which 38 healthy macaques were infected with <em>M. tuberculosis</em>. Data measurements were taken at baseline (before infection) and at 11 additional unequally spaced timepoints up to 6 months post infection. Each macaque was identified as developing symptomatic (active) TB or asymptomatic (latent) infection. For the purposes of illustration and time, a subset of the microarray data was chosen for analysis. We randomly selected 4000 probes from those contained within the first seven rounds of the Baylor modules, 10 macaques, and 3 time points (days 0, 20, and 42). For the flow, data was collected on 19 of the 38 macaques and 13 variables are analyzed. For more details about modeling in limma, refer to the limma User’s Guide.</p>
<div id="microarray" class="section level4">
<h4>Microarray</h4>
<p>Create a grouping factor by combining clinical status and time point.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tb.design$Group &lt;-<span class="st"> </span><span class="kw">paste</span>(tb.design$clinical_status, tb.design$timepoint, <span class="dt">sep =</span> <span class="st">&quot;&quot;</span>)
grp &lt;-<span class="st"> </span><span class="kw">factor</span>(tb.design$Group)</code></pre></div>
<p>Create a design matrix that includes separate coefficients for each level within the grouping factor so that the desired differences can be extracted as contrasts.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">design2 &lt;-<span class="st"> </span><span class="kw">model.matrix</span>(~<span class="dv">0</span>+grp)
<span class="kw">colnames</span>(design2) &lt;-<span class="st"> </span><span class="kw">levels</span>(grp)</code></pre></div>
<p>Since there are repeated measurements on each monkey, we treat monkey_id as a random effect and estimate the correlation between measurements on the same subject. In limma, this is done using duplicateCorrelation.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dupcor &lt;-<span class="st"> </span><span class="kw">duplicateCorrelation</span>(tb.expr, design2, <span class="dt">block =</span> tb.design$monkey_id)</code></pre></div>
<p>Fit model and extract contrasts of interest.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fit &lt;-<span class="st"> </span><span class="kw">lmFit</span>(tb.expr, design2, <span class="dt">block =</span> tb.design$monkey_id, <span class="dt">correlation =</span> dupcor$consensus.correlation)
contrasts &lt;-<span class="st"> </span><span class="kw">makeContrasts</span>(<span class="dt">A_20vsPre =</span> Active20-Active0, <span class="dt">A_42vsPre =</span> Active42-Active0,
                           <span class="dt">L_20vsPre =</span> Latent20-Latent0, <span class="dt">L_42vsPre =</span> Latent42-Latent0,
                           <span class="dt">levels=</span>design2)

fit2 &lt;-<span class="st"> </span><span class="kw">contrasts.fit</span>(fit, contrasts)
fit2 &lt;-<span class="st"> </span><span class="kw">eBayes</span>(fit2, <span class="dt">trend =</span> <span class="ot">FALSE</span>)</code></pre></div>
</div>
<div id="flow" class="section level4">
<h4>Flow</h4>
<p>Analysis of flow data in limma proceeds similarly.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tb.flow.des$Group &lt;-<span class="st"> </span><span class="kw">paste</span>(tb.flow.des$clinical_status, tb.flow.des$timepoint, <span class="dt">sep =</span> <span class="st">&quot;&quot;</span>)
grp &lt;-<span class="st"> </span><span class="kw">factor</span>(tb.flow.des$Group)

design2 &lt;-<span class="st"> </span><span class="kw">model.matrix</span>(~<span class="dv">0</span>+grp)
<span class="kw">colnames</span>(design2) &lt;-<span class="st"> </span><span class="kw">levels</span>(grp)
dupcor &lt;-<span class="st"> </span><span class="kw">duplicateCorrelation</span>(tb.flow, design2, <span class="dt">block =</span> tb.flow.des$monkey_id)

fit.flow &lt;-<span class="st"> </span><span class="kw">lmFit</span>(tb.flow, design2, <span class="dt">block =</span> tb.flow.des$monkey_id, <span class="dt">correlation =</span> dupcor$consensus.correlation)

<span class="co"># Add more contrasts since we have all timepoints available. Additional contrasts could be added as well.</span>
contrasts &lt;-<span class="st"> </span><span class="kw">makeContrasts</span>(<span class="dt">A_20vsPre =</span> Active20-Active0, <span class="dt">A_30vsPre =</span> Active30-Active0,
                           <span class="dt">A_42vsPre =</span> Active42-Active0, <span class="dt">A_56vsPre =</span> Active56-Active0,
                           <span class="dt">L_20vsPre =</span> Latent20-Latent0, <span class="dt">L_30vsPre =</span> Latent30-Latent0,
                           <span class="dt">L_42vsPre =</span> Latent42-Latent0, <span class="dt">L_46vsPre =</span> Latent56-Latent0,
                           <span class="dt">levels=</span>design2)

fit2.flow &lt;-<span class="st"> </span><span class="kw">contrasts.fit</span>(fit.flow, contrasts)
fit2.flow &lt;-<span class="st"> </span><span class="kw">eBayes</span>(fit2.flow, <span class="dt">trend =</span> <span class="ot">FALSE</span>)</code></pre></div>
</div>
</div>
<div id="generate-model-results-file" class="section level3">
<h3>Generate Model Results File</h3>
<p>The next step in the process is to generate a model results file that is formatted specifically for BART. This can be done by using the <code>genModelResults</code> function, which takes as input the results output from <code>desInfo</code>, as well as models run in limma, DESeq2, or edgeR. In our example, we are ran limma models on both microarray and flow data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mod_results &lt;-<span class="st"> </span><span class="kw">genModelResults</span>(<span class="dt">design_info =</span> des.info, <span class="dt">object =</span> fit2, <span class="dt">lm_Fit =</span> fit, <span class="dt">method =</span> <span class="st">&quot;limma&quot;</span>)
mod_results.flow &lt;-<span class="st"> </span><span class="kw">genModelResults</span>(<span class="dt">design_info =</span> des.info.flow, <span class="dt">object =</span> fit2.flow, <span class="dt">lm_Fit =</span> fit.flow,
                                    <span class="dt">method =</span> <span class="st">&quot;limma&quot;</span>)</code></pre></div>
</div>
<div id="gene-set-analysis" class="section level3">
<h3>Gene Set Analysis</h3>
<p>Next we run gene set analysis by incorporating functions available in the <code>qusage</code> package, which tests whether the average log2 fold change of the genes within a gene set are different than 0. The The function <code>qBart</code> simplifies the process by requiring only two input parameters, the model results object produced by <code>genModelResults</code> and a list of gene sets.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">qus &lt;-<span class="st"> </span><span class="kw">qBart</span>(<span class="dt">object =</span> mod_results, <span class="dt">gene_sets =</span> modules)
<span class="co">#&gt; Aggregating gene data for gene sets.Done. </span>
<span class="co">#&gt; Calculating VIF's on residual matrix.</span>
<span class="co">#&gt; Q-Gen analysis complete.Aggregating gene data for gene sets.Done. </span>
<span class="co">#&gt; Calculating VIF's on residual matrix.</span>
<span class="co">#&gt; Q-Gen analysis complete.Aggregating gene data for gene sets.Done. </span>
<span class="co">#&gt; Calculating VIF's on residual matrix.</span>
<span class="co">#&gt; Q-Gen analysis complete.Aggregating gene data for gene sets.Done. </span>
<span class="co">#&gt; Calculating VIF's on residual matrix.</span>
<span class="co">#&gt; Q-Gen analysis complete.</span></code></pre></div>
</div>
<div id="correlations" class="section level3">
<h3>Correlations</h3>
<p>In addition to providing tools for the standard analysis workflow, BART also offers a tool that allows users to visualize and sort through potentially hundreds of thousands pairwise correlations between clinical outcomes. The <code>crossCorr</code> function takes two data frames of outcomes and outputs a long format file of all pairwise correlations. We walk through an example in which we wish to correlate module activity scores with flow variables. Since this is a longitudinal setting, we correlate by time.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Create time variable</span>
time &lt;-<span class="st"> </span>module.as$time
module.as$time &lt;-<span class="st"> </span><span class="ot">NULL</span>

<span class="co"># Format flow data to run correlations and match flow samples with module.as</span>
flow &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="kw">t</span>(tb.flow))
flow &lt;-<span class="st"> </span>flow[<span class="kw">match</span>(<span class="kw">rownames</span>(module.as), <span class="kw">rownames</span>(flow), <span class="dt">nomatch =</span> <span class="dv">0</span>), ]

<span class="co"># Run correlations formatted for BART</span>
corrs &lt;-<span class="st"> </span><span class="kw">crossCorr</span>(<span class="dt">x =</span> module.as, <span class="dt">y =</span> flow, <span class="dt">by =</span> time, <span class="dt">by_name =</span> <span class="st">&quot;days&quot;</span>, 
                   <span class="dt">description =</span> <span class="st">&quot;Mod.Act.Score vs Flow&quot;</span>, <span class="dt">x_var =</span> <span class="st">&quot;Mod.Act.Score&quot;</span>, 
                   <span class="dt">y_var =</span> <span class="st">&quot;Flow&quot;</span>, <span class="dt">method =</span> <span class="st">&quot;spearman&quot;</span>)</code></pre></div>
</div>
<div id="generate-bart-file" class="section level3">
<h3>Generate BART file</h3>
<p>The last step in the process is to generate the final file that can be uploaded into BART. This is done through the function <code>genFile</code>, which takes as its arguments the objects generated from the previous functions. Not every object is required to generate a BART file. For example, if gene set analysis and correlations are not run, <code>desInfo</code>, <code>genDendrograms</code>, <code>genModules</code>, and <code>genModelResults</code> objects can still be run through <code>genFile</code>. BART will only show the results that are uploaded in.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">genFile</span>(<span class="dt">design_info =</span> <span class="kw">list</span>(des.info, des.info.flow), <span class="dt">module_maps =</span> mods, <span class="dt">dendros =</span> dendros, 
        <span class="dt">model_results =</span> <span class="kw">list</span>(mod_results, mod_results.flow))</code></pre></div>
<p>In our example, we did run gene set analysis and correlations. Adding these results into BART is made simple through the <code>updateFile</code> function. The user must simply provide the path to the BART file that needs to be updated and add the new additions in the same way that <code>genFile</code> takes them.</p>
<pre><code>path &lt;- paste(getwd(), &quot;/&quot;, des.info$project_name, &quot; Pipeline&quot;, sep = &quot;&quot;)
updateFile(load.path = path, qusage_results = qus, corr_results = list(corrs))</code></pre>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
